<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Subir imagen a Google Drive</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>Subir imagen a Google Drive (en carpeta específica)</h2>
  <input type="file" id="fileInput" accept="image/*" />
  <button onclick="handleUpload()">Subir</button>

  <script>
    const CLIENT_ID = '381451210993-le8vnu9akeospf5otsth28gqfpfiqdor.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyBRKOLQ8geTP_IEyazlzupv_AS-GhFskN8';
    const FOLDER_ID = '1tOMPi7-mWwPJTBJioaxugDeT5Uo47MH_';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let authReady = false;

    function authenticate() {
      if (!authReady) {
        return Promise.reject("gapi.auth2 no está listo aún");
      }

      return gapi.auth2.getAuthInstance()
        .signIn({ scope: SCOPES })
        .then(() => console.log("✅ Autenticado correctamente"))
        .catch(err => console.error("❌ Error al autenticar", err));
    }

    function loadClient() {
      gapi.client.setApiKey(API_KEY);
      return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/drive/v3/rest")
        .then(() => console.log("✅ Cliente de Google Drive cargado"))
        .catch(err => console.error("❌ Error al cargar cliente", err));
    }

    function handleUpload() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      if (!file) return alert("⚠️ Selecciona un archivo primero");

      authenticate()
        .then(loadClient)
        .then(() => {
          const metadata = {
            name: file.name,
            mimeType: file.type,
            parents: [FOLDER_ID]
          };

          const accessToken = gapi.auth.getToken().access_token;
          const form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          form.append('file', file);

          return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
            body: form,
          });
        })
        .then(res => res.json())
        .then(val => {
          if (val.id) {
            alert("✅ Imagen subida correctamente con ID: " + val.id);
          } else {
            alert("❌ Error al subir la imagen");
            console.log(val);
          }
        })
        .catch(err => {
          console.error("❌ Error en el proceso de subida:", err);
        });
    }

    function initGapi() {
      gapi.load("client:auth2", () => {
        gapi.auth2.init({ client_id: CLIENT_ID })
          .then(() => {
            authReady = true;
            console.log("✅ gapi.auth2 inicializado");
          })
          .catch(err => {
            console.error("❌ Error al inicializar gapi.auth2:", err);
          });
      });
    }

    window.onload = initGapi;
  </script>
</body>
</html>
